{% extends 'dashboard/base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% block content %}

<div class="container mt-5">
    <!-- GROUP SELECTION -->
    <div class="row mb-4">
        <div class="col-md-9">
            <div class="d-flex gap-2">
                <a href="{% url 'notes' %}"
                    class="btn {% if not active_group %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    All Notes
                </a>
                {% for group in groups %}
                <div class="btn-group">
                    <a href="{% url 'notes' %}?group={{ group.id }}"
                        class="btn {% if active_group and active_group.id == group.id %}btn-{{ group.color }}{% else %}btn-outline-{{ group.color }}{% endif %}">
                        {{ group.name }}
                    </a>
                    <a href="{% url 'delete-notes-group' group.id %}"
                        class="btn {% if active_group and active_group.id == group.id %}btn-{{ group.color }}{% else %}btn-outline-{{ group.color }}{% endif %}"
                        onclick="return confirm('Are you sure you want to delete this group? All notes will be ungrouped.')">
                        <i class="fas fa-times"></i>
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="col-md-3">
            <button type="button" class="btn btn-outline-success w-100" data-bs-toggle="modal"
                data-bs-target="#createGroupModal">
                <i class="fas fa-folder-plus"></i> New Group
            </button>
        </div>
    </div>

    <!-- NOTES GRID -->
    <div class="row g-4">
        {% if active_group %}
        <div class="col-12">
            <div class="alert alert-{{ active_group.color }} mb-4">
                <h4 class="mb-1">{{ active_group.name }}</h4>
                {% if active_group.description %}
                <p class="mb-0">{{ active_group.description }}</p>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% for note in notes %}
        <div class="col-md-3">
            <a href="{% url 'notes-detail' note.id %}" style="text-decoration: none; color: inherit;">
                <div class="card shadow rounded h-100">
                    <div
                        class="card-header {% if note.group %}bg-{{ note.group.color }}{% else %}bg-primary{% endif %} text-white">
                        {{ note.title }}
                        {% if note.group and not active_group %}
                        <span class="badge bg-light text-dark float-end">{{ note.group.name }}</span>
                        {% endif %}
                    </div>
                    <div class="card-body text-center">
                        {% if note.image %}
                        <img src="{{ note.image.url }}" alt="Note Image" class="img-fluid rounded mb-2"
                            style="max-height:150px; object-fit:cover;">
                        {% if note.description %}
                        <small class="text-muted d-block">
                            {{ note.description|slice:"0:60" }}
                            {% if note.description|length > 60 %}...{% endif %}
                        </small>
                        {% endif %}
                        {% else %}
                        {{ note.description|slice:"0:100" }}{% if note.description|length > 100 %}...{% endif %}
                        {% endif %}
                    </div>
                    <div class="card-footer d-flex justify-content-end">
                        <a href="{% url 'delete-note' note.id %}" class="text-danger">
                            <i class="fa fa-trash fa-2x"></i>
                        </a>
                    </div>
                </div>
            </a>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-info">
                {% if active_group %}
                No notes in this group yet. Create one below!
                {% else %}
                No notes yet. Create one below!
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- CREATE NOTE FORM -->
    <div class="card shadow rounded p-4 mt-5">
        <h3 class="mb-3">Create Note</h3>
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form|crispy }}
            <button type="submit" class="btn btn-primary w-100">Create</button>
        </form>
    </div>
</div>

<!-- Create Group Modal -->
<div class="modal fade" id="createGroupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Group</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST">
                <div class="modal-body">
                    {% csrf_token %}
                    <input type="hidden" name="create_group" value="1">
                    {{ group_form|crispy }}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Create Group</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock content %}